<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PropertySim: Portfolio Manager</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for in-browser transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Fonts -->
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
      body {
        font-family: 'Inter', sans-serif;
        background-color: #f8fafc;
      }
      /* Custom scrollbar for better aesthetics */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f5f9; 
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1; 
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8; 
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.554.0",
    "recharts": "https://aistudiocdn.com/recharts@^3.5.0"
  }
}
</script>
</head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useMemo } from 'https://esm.sh/react@18.2.0';
      import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
      import { 
        Plus, Briefcase, TrendingUp, DollarSign, Clock, Building, 
        PieChart, Home, Store, Wallet, Coins, BarChart2, 
        ArrowDownCircle, Building2, Landmark, Percent, X, 
        HelpCircle, AlertTriangle 
      } from 'https://esm.sh/lucide-react@0.292.0?deps=react@18.2.0';
      import { 
        LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, 
        ResponsiveContainer, Legend 
      } from 'https://esm.sh/recharts@2.12.0?deps=react@18.2.0,react-dom@18.2.0';

      // --- TYPES ---
      
      const INITIAL_GAME_STATE = {
        year: 0,
        month: 0,
        cash: 0,
        salary: 0,
        savingsRate: 0,
        maxBorrowingPerTrust: 0,
        trusts: [],
        history: [],
        setupComplete: false,
      };

      // --- UTILS ---

      const formatCurrency = (amount) => {
        return new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD',
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        }).format(amount);
      };

      const formatNumber = (amount) => {
        return new Intl.NumberFormat('en-US').format(amount);
      };

      const parseFormattedNumber = (value) => {
        return Number(value.replace(/,/g, ''));
      };

      const calculateMonthlyInterest = (loan, rate) => {
        return (loan * (rate / 100)) / 12;
      };

      // 88% LVR Cap for Equity Release
      const getMaxLoan = (value) => {
        return value * 0.88;
      };

      const calculateLMI = (loanAmount, value) => {
        const lvr = loanAmount / value;
        // Simple rule: If LVR > 80%, LMI is roughly 1.5% of the total loan amount
        if (lvr > 0.80) {
          return loanAmount * 0.015;
        }
        return 0;
      };

      // --- COMPONENTS ---

      // Logo Component
      const AppLogo = ({ size = "large" }) => {
        const isLarge = size === "large";
        return (
          <div className={`${isLarge ? "w-24 h-24" : "w-10 h-10"} relative`}>
            <svg 
              viewBox="0 0 100 100" 
              className={`w-full h-full drop-shadow-md`}
              fill="none" 
              xmlns="http://www.w3.org/2000/svg"
            >
              {/* House Background */}
              <path d="M10 50 L50 15 L90 50 V90 H10 Z" fill="#2563EB" stroke="white" strokeWidth="4" strokeLinejoin="round"/>
              
              {/* Dollar Sign */}
              <text x="50" y="75" fontSize="45" fontWeight="bold" textAnchor="middle" fill="white" fontFamily="sans-serif">$</text>
              
              {/* Growth Arrow */}
              <path d="M65 75 L85 55 M85 55 H70 M85 55 V70" stroke="#4ade80" strokeWidth="6" strokeLinecap="round" strokeLinejoin="round" />
            </svg>
          </div>
        );
      };

      // 1. StatCard
      const StatCard = ({ label, value, subValue, icon, color = 'slate' }) => {
        const colorClasses = {
          slate: 'bg-white border-slate-200',
          blue: 'bg-blue-50 border-blue-100',
          green: 'bg-emerald-50 border-emerald-100',
          red: 'bg-rose-50 border-rose-100',
        };

        return (
          <div className={`p-4 rounded-xl border shadow-sm ${colorClasses[color]} flex flex-col justify-between h-full`}>
            <div className="flex justify-between items-start mb-2">
              <span className="text-xs font-semibold text-slate-500 uppercase tracking-wider">{label}</span>
              {icon && <div className="text-slate-400">{icon}</div>}
            </div>
            <div>
              <div className="text-xl lg:text-2xl font-bold text-slate-800">{value}</div>
              {subValue && <div className="text-xs text-slate-500 mt-1">{subValue}</div>}
            </div>
          </div>
        );
      };

      // 2. SetupScreen
      const SetupScreen = ({ onStart }) => {
        const [salary, setSalary] = useState(150000);
        const [savingsRate, setSavingsRate] = useState(20);
        const [cash, setCash] = useState(200000);
        const [maxBorrowing, setMaxBorrowing] = useState(1000000);

        const handleSubmit = (e) => {
          e.preventDefault();
          onStart({
            salary,
            savingsRate,
            cash,
            maxBorrowingPerTrust: maxBorrowing,
            history: [{ label: 'Start', netWorth: cash, cash: cash, debt: 0 }]
          });
        };

        const handleCurrencyChange = (value, setter) => {
          const num = parseFormattedNumber(value);
          if (!isNaN(num)) setter(num);
        };

        return (
          <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
            <div className="bg-white p-8 rounded-xl shadow-xl w-full max-w-md border-t-4 border-blue-600">
              <div className="mb-6 text-center flex flex-col items-center">
                <div className="mb-4 transform hover:scale-105 transition duration-300">
                  <AppLogo size="large" />
                </div>
                <h1 className="text-2xl font-bold text-slate-800">PropertySim</h1>
                <p className="text-slate-500 mt-2">Configure your portfolio parameters</p>
              </div>

              <form onSubmit={handleSubmit} className="space-y-6">
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1 flex items-center gap-2">
                    <Wallet className="w-4 h-4" /> Annual Salary
                  </label>
                  <div className="relative">
                    <span className="absolute left-3 top-2.5 text-slate-500">$</span>
                    <input
                      type="text"
                      required
                      value={formatNumber(salary)}
                      onChange={(e) => handleCurrencyChange(e.target.value, setSalary)}
                      className="w-full pl-8 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                    />
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1 flex items-center gap-2">
                    <Percent className="w-4 h-4" /> Savings Rate
                  </label>
                  <p className="text-xs text-slate-400 mb-2">% of salary added to cash annually.</p>
                  <div className="relative">
                    <span className="absolute left-3 top-2.5 text-slate-500">%</span>
                    <input
                      type="number"
                      required
                      min="0"
                      max="100"
                      value={savingsRate}
                      onChange={(e) => setSavingsRate(Number(e.target.value))}
                      className="w-full pl-8 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                    />
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1 flex items-center gap-2">
                    <Landmark className="w-4 h-4" /> Initial Cash Savings
                  </label>
                  <div className="relative">
                    <span className="absolute left-3 top-2.5 text-slate-500">$</span>
                    <input
                      type="text"
                      required
                      value={formatNumber(cash)}
                      onChange={(e) => handleCurrencyChange(e.target.value, setCash)}
                      className="w-full pl-8 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                    />
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1 flex items-center gap-2">
                    <Building2 className="w-4 h-4" /> Max Borrowing per Trust
                  </label>
                  <div className="relative">
                    <span className="absolute left-3 top-2.5 text-slate-500">$</span>
                    <input
                      type="text"
                      required
                      value={formatNumber(maxBorrowing)}
                      onChange={(e) => handleCurrencyChange(e.target.value, setMaxBorrowing)}
                      className="w-full pl-8 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                    />
                  </div>
                </div>

                <button
                  type="submit"
                  className="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg shadow-md transition duration-200 transform hover:scale-[1.02]"
                >
                  Start Portfolio
                </button>
              </form>
            </div>
          </div>
        );
      };

      // 3. Modals
      const Modal = ({ title, onClose, children }) => (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden animate-in fade-in zoom-in duration-200 max-h-[90vh] overflow-y-auto">
            <div className="flex justify-between items-center p-4 border-b bg-slate-50 sticky top-0 z-10">
              <h3 className="font-bold text-lg text-slate-800">{title}</h3>
              <button onClick={onClose} className="p-1 hover:bg-slate-200 rounded-full transition">
                <X className="w-5 h-5 text-slate-500" />
              </button>
            </div>
            <div className="p-6">{children}</div>
          </div>
        </div>
      );

      const BuyPropertyModal = ({ trusts, cash, maxBorrowingPerTrust, initialTrustId, onClose, onBuy }) => {
        const [trustId, setTrustId] = useState(initialTrustId || trusts[0]?.id || '');
        const [name, setName] = useState('');
        const [type, setType] = useState('RESIDENTIAL');
        const [price, setPrice] = useState(500000);
        const [lvr, setLvr] = useState(88); 
        const [rate, setRate] = useState(6.0);
        const [growth, setGrowth] = useState(20.0);
        const [yieldRate, setYieldRate] = useState(5.0);
        const [otherCosts, setOtherCosts] = useState(40000);

        useEffect(() => {
          const allProps = trusts.flatMap(t => t.properties);
          const count = allProps.filter(p => p.type === type).length + 1;
          setName(type === 'RESIDENTIAL' ? `IP ${count}` : `Commercial ${count}`);
        }, [type, trusts]);

        const handleTypeChange = (newType) => {
          setType(newType);
          if (newType === 'COMMERCIAL') {
            setPrice(1000000);
            setLvr(65);
            setGrowth(4.0);
          } else {
            setPrice(500000);
            setLvr(88);
            setGrowth(20.0);
          }
        };

        const handleCurrencyChange = (value, setter) => {
            const num = parseFormattedNumber(value);
            if(!isNaN(num)) setter(num);
        }
        
        const handlePercentChange = (value, setter) => {
            if (value === '') {
                setter('');
            } else {
                setter(Number(value));
            }
        }

        const loanAmount = price * (lvr / 100);
        const depositRequired = price - loanAmount;
        const totalUpfront = depositRequired + otherCosts;
        
        const selectedTrust = trusts.find((t) => t.id === trustId);
        const currentTrustDebt = selectedTrust?.properties.reduce((acc, p) => acc + p.loan, 0) || 0;
        const newTrustDebt = currentTrustDebt + loanAmount;
        const isOverBorrowing = newTrustDebt > maxBorrowingPerTrust;
        const isAffordable = totalUpfront <= cash;

        return (
          <Modal title="Acquire Asset" onClose={onClose}>
            <form onSubmit={(e) => {
              e.preventDefault();
              if (!isOverBorrowing && isAffordable) {
                onBuy(trustId, { 
                  name, 
                  type, 
                  value: price, 
                  originalPrice: price,
                  loan: loanAmount, 
                  interestRate: Number(rate), 
                  growthRate: Number(growth), 
                  yieldRate: Number(yieldRate) 
                }, totalUpfront);
              }
            }} className="space-y-4">
              
              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">Select Trust</label>
                <select value={trustId} onChange={(e) => setTrustId(e.target.value)} className="w-full border p-2 rounded-lg bg-slate-50">
                  {trusts.map((t) => (
                    <option key={t.id} value={t.id}>{t.name} (Debt: {formatCurrency(t.properties.reduce((acc, p) => acc + p.loan, 0))})</option>
                  ))}
                </select>
                {isOverBorrowing && <p className="text-xs text-red-500 mt-1">Exceeds Trust Borrowing Capacity of {formatCurrency(maxBorrowingPerTrust)}</p>}
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">Property Name</label>
                  <input required type="text" placeholder="e.g. 123 Main St" value={name} onChange={(e) => setName(e.target.value)} className="w-full border p-2 rounded-lg" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">Type</label>
                  <select value={type} onChange={(e) => handleTypeChange(e.target.value)} className="w-full border p-2 rounded-lg">
                    <option value="RESIDENTIAL">Bread and butter</option>
                    <option value="COMMERCIAL">Commercial</option>
                  </select>
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">Purchase Price</label>
                <div className="relative">
                  <span className="absolute left-3 top-2 text-slate-500">$</span>
                  <input type="text" value={formatNumber(price)} onChange={(e) => handleCurrencyChange(e.target.value, setPrice)} className="w-full border pl-6 p-2 rounded-lg" />
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4 bg-blue-50 p-3 rounded-lg border border-blue-100">
                <div>
                  <label className="block text-sm font-medium text-blue-900 mb-1">LVR</label>
                  <div className="relative">
                    <input 
                      type="number" 
                      min="0" 
                      max="100" 
                      value={lvr} 
                      onChange={(e) => setLvr(Number(e.target.value))} 
                      className="w-full border p-2 rounded-lg text-center font-bold text-blue-800 pr-6" 
                    />
                    <span className="absolute right-3 top-2 text-blue-600 font-bold">%</span>
                  </div>
                  <p className="text-xs text-blue-600 mt-1 text-center">Loan: {formatCurrency(loanAmount)}</p>
                </div>
                <div>
                   <label className="block text-sm font-medium text-blue-900 mb-1">Required Deposit</label>
                   <div className="w-full border p-2 rounded-lg bg-white text-slate-500 text-center">
                      {formatCurrency(depositRequired)}
                   </div>
                </div>
              </div>

              <div className="grid grid-cols-3 gap-4">
                 <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">Loan Interest Rate</label>
                  <div className="relative">
                      <input type="number" step="0.1" value={rate} onChange={(e) => handlePercentChange(e.target.value, setRate)} className="w-full border p-2 pr-6 rounded-lg" />
                      <span className="absolute right-3 top-2 text-slate-500">%</span>
                  </div>
                </div>
                 <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1 leading-tight">Annual growth</label>
                  <div className="relative">
                      <input type="number" step="0.1" value={growth} onChange={(e) => handlePercentChange(e.target.value, setGrowth)} className="w-full border p-2 pr-6 rounded-lg" />
                      <span className="absolute right-3 top-2 text-slate-500">%</span>
                  </div>
                </div>
                 <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">Yield</label>
                  <div className="relative">
                      <input type="number" step="0.1" value={yieldRate} onChange={(e) => handlePercentChange(e.target.value, setYieldRate)} className="w-full border p-2 pr-6 rounded-lg" />
                      <span className="absolute right-3 top-2 text-slate-500">%</span>
                  </div>
                </div>
              </div>

              <div>
                  <div className="flex items-center gap-2 mb-1">
                    <label className="block text-sm font-medium text-slate-700">Other Costs</label>
                    <div className="group relative">
                      <HelpCircle className="w-4 h-4 text-slate-400 cursor-help" />
                      <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-48 bg-slate-800 text-white text-xs p-2 rounded hidden group-hover:block z-20">
                        Includes Stamp Duty, Legal Fees, and Buyer's Agency Fees.
                      </div>
                    </div>
                  </div>
                  <div className="relative">
                    <span className="absolute left-3 top-2 text-slate-500">$</span>
                    <input type="text" value={formatNumber(otherCosts)} onChange={(e) => handleCurrencyChange(e.target.value, setOtherCosts)} className="w-full border pl-6 p-2 rounded-lg" />
                  </div>
              </div>

              <div className="bg-slate-100 p-3 rounded-lg text-sm space-y-2 border border-slate-200">
                  <div className="flex justify-between"><span>Deposit ({(100-lvr).toFixed(0)}%):</span> <span>{formatCurrency(depositRequired)}</span></div>
                  <div className="flex justify-between"><span>Other Costs:</span> <span>{formatCurrency(otherCosts)}</span></div>
                  <div className="h-px bg-slate-300 my-1"></div>
                  <div className="flex justify-between font-bold text-lg"><span>Total Cash Required:</span> <span className={isAffordable ? 'text-slate-800' : 'text-red-600'}>{formatCurrency(totalUpfront)}</span></div>
                  {!isAffordable && <div className="text-red-500 text-xs text-right font-medium">Insufficient Cash</div>}
              </div>

              <button 
                  disabled={!isAffordable || isOverBorrowing || !name} 
                  type="submit" 
                  className="w-full bg-blue-600 disabled:bg-slate-300 disabled:cursor-not-allowed hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"
              >
                  Complete Purchase
              </button>
            </form>
          </Modal>
        );
      };

      const SellPropertyModal = ({ property, trustId, currentDate, onClose, onSell }) => {
          const currentMonthTotal = currentDate.year * 12 + currentDate.month;
          const monthsHeld = currentMonthTotal - property.boughtAt;
          
          const [cgtRate, setCgtRate] = useState(30); 
          const [applyDiscount, setApplyDiscount] = useState(monthsHeld >= 12);
          
          const sellingCostsRate = 0.02; 
          const sellingCosts = property.value * sellingCostsRate;
          const loanPayout = property.loan;
          
          const grossProfit = property.value - property.originalPrice;
          
          const taxRate = Number(cgtRate);
          const capitalGain = property.value - sellingCosts - property.originalPrice;
          const taxableAmount = applyDiscount && capitalGain > 0 ? capitalGain * 0.5 : capitalGain;
          const taxPayable = taxableAmount > 0 ? taxableAmount * (taxRate / 100) : 0;

          const netProceeds = property.value - loanPayout - sellingCosts - taxPayable;

          const handlePercentChange = (value, setter) => {
              if (value === '') {
                  setter('');
              } else {
                  setter(Number(value));
              }
          }

          return (
              <Modal title="Sell Property & Tax" onClose={onClose}>
                  <div className="space-y-6">
                      <div className="bg-slate-50 p-4 rounded-lg border border-slate-200">
                          <h4 className="font-bold text-slate-800 text-lg mb-1">{property.name}</h4>
                          <p className="text-slate-500 text-sm">Held for {Math.floor(monthsHeld / 12)} Years, {monthsHeld % 12} Months</p>
                      </div>

                      <div className="space-y-3 text-sm">
                          <div className="flex justify-between items-center py-1">
                              <span className="text-slate-600">Sale Price</span>
                              <span className="font-semibold text-slate-800">{formatCurrency(property.value)}</span>
                          </div>
                           <div className="flex justify-between items-center py-1 text-slate-400">
                              <span>Original Purchase Price</span>
                              <span>-{formatCurrency(property.originalPrice)}</span>
                          </div>
                           <div className="flex justify-between items-center py-1 border-b border-slate-100 pb-2">
                              <span>Selling Costs (2%)</span>
                              <span className="text-red-500">-{formatCurrency(sellingCosts)}</span>
                          </div>
                          
                          <div className="flex justify-between items-center py-1 font-medium text-slate-700">
                              <span>Gross Capital Gain</span>
                              <span>{formatCurrency(Math.max(0, capitalGain))}</span>
                          </div>

                          <div className="bg-orange-50 p-3 rounded-lg border border-orange-100 space-y-3 mt-2">
                              <div className="flex justify-between items-center">
                                  <label className="text-orange-900 font-medium text-sm">Est. Tax Rate (%)</label>
                                  <div className="relative w-24">
                                      <input 
                                          type="number" 
                                          value={cgtRate} 
                                          onChange={(e) => handlePercentChange(e.target.value, setCgtRate)} 
                                          className="w-full border border-orange-200 rounded p-1 text-right pr-6 focus:ring-orange-500"
                                      />
                                      <span className="absolute right-2 top-1 text-orange-400 text-sm">%</span>
                                  </div>
                              </div>
                              <div className="flex items-center gap-2">
                                  <input 
                                      type="checkbox" 
                                      id="cgtDiscount"
                                      checked={applyDiscount} 
                                      onChange={(e) => setApplyDiscount(e.target.checked)}
                                      className="rounded text-orange-600 focus:ring-orange-500"
                                  />
                                  <label htmlFor="cgtDiscount" className="text-sm text-orange-800">Apply 50% CGT Discount (Held &gt; 12m)</label>
                              </div>
                              <div className="flex justify-between items-center pt-2 border-t border-orange-200 font-medium text-orange-800">
                                  <span>Tax Payable to ATO</span>
                                  <span>{formatCurrency(taxPayable)}</span>
                              </div>
                          </div>

                          <div className="flex justify-between items-center py-2 border-t border-slate-200">
                              <span className="text-slate-600">Less: Loan Discharge</span>
                              <span className="text-red-600">-{formatCurrency(loanPayout)}</span>
                          </div>
                          
                          <div className="flex justify-between items-center pt-2 text-lg bg-emerald-50 p-3 rounded-lg border border-emerald-100 mt-2">
                              <span className="font-bold text-emerald-900">Net Cash to Bank</span>
                              <span className="font-bold text-emerald-600">{formatCurrency(netProceeds)}</span>
                          </div>
                      </div>

                      <div className="flex gap-3 mt-6">
                          <button 
                              onClick={onClose}
                              className="flex-1 px-4 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50 transition font-medium"
                          >
                              Cancel
                          </button>
                          <button 
                              onClick={() => onSell(trustId, property.id, netProceeds)}
                              className="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-bold shadow-md"
                          >
                              Confirm Sale
                          </button>
                      </div>
                  </div>
              </Modal>
          )
      }

      const PayDownModal = ({ property, trustId, cashAvailable, onClose, onPayDown }) => {
          const [amount, setAmount] = useState('');
          const maxPayable = Math.min(cashAvailable, property.loan);
          const numAmount = Number(amount);

          return (
              <Modal title="Pay Down Loan" onClose={onClose}>
                   <div className="space-y-5">
                       <div className="bg-blue-50 p-3 rounded-lg border border-blue-100 text-sm text-blue-800">
                           Paying down debt reduces your interest expenses and increases cashflow, but consumes available cash.
                       </div>
                       
                       <div className="grid grid-cols-2 gap-4 text-sm">
                           <div className="p-2 border rounded bg-slate-50">
                               <span className="block text-slate-500 text-xs uppercase">Current Loan</span>
                               <span className="font-bold text-slate-800">{formatCurrency(property.loan)}</span>
                           </div>
                           <div className="p-2 border rounded bg-slate-50">
                               <span className="block text-slate-500 text-xs uppercase">Cash Available</span>
                               <span className="font-bold text-emerald-600">{formatCurrency(cashAvailable)}</span>
                           </div>
                       </div>

                       <div>
                          <label className="block text-sm font-medium text-slate-700 mb-1">Payment Amount</label>
                          <div className="relative">
                              <span className="absolute left-3 top-2.5 text-slate-500">$</span>
                              <input 
                                  type="text"
                                  value={amount === '' ? '' : formatNumber(numAmount)}
                                  onChange={(e) => {
                                      const val = parseFormattedNumber(e.target.value);
                                      if (!isNaN(val) && val <= maxPayable) setAmount(val);
                                      if (e.target.value === '') setAmount('');
                                  }}
                                  className="w-full border pl-8 p-2 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                  placeholder="0"
                              />
                          </div>
                          <div className="flex justify-end gap-2 mt-1">
                              <button onClick={() => setAmount(maxPayable)} className="text-xs text-blue-600 hover:underline">Max Available</button>
                          </div>
                       </div>

                       <button 
                          disabled={numAmount <= 0}
                          onClick={() => onPayDown(trustId, property.id, numAmount)}
                          className="w-full bg-blue-600 text-white font-bold py-3 rounded-lg disabled:bg-slate-300 disabled:cursor-not-allowed hover:bg-blue-700 transition"
                       >
                           Pay {numAmount > 0 ? formatCurrency(numAmount) : ''} & Reduce Debt
                       </button>
                   </div>
              </Modal>
          )
      }

      const RefinanceModal = ({ properties, maxBorrowingPerTrust, trusts, initialSelection, onClose, onRefinance }) => {
          const [selectedId, setSelectedId] = useState(initialSelection?.propertyId || properties[0]?.prop.id || '');
          const [amountToRelease, setAmountToRelease] = useState(0);

          useEffect(() => {
              if (initialSelection) {
                  setSelectedId(initialSelection.propertyId);
              }
          }, [initialSelection]);

          const selected = properties.find(p => p.prop.id === selectedId);
          const property = selected?.prop;
          const trust = trusts.find(t => t.id === selected?.trustId);
          
          if (!property || !trust) return null;

          const maxLoan = getMaxLoan(property.value);
          const availableEquity = Math.max(0, maxLoan - property.loan);
          const trustCurrentDebt = trust.properties.reduce((acc, p) => acc + p.loan, 0);
          const trustRemainingCapacity = Math.max(0, maxBorrowingPerTrust - trustCurrentDebt);
          
          const maxReleaseable = Math.min(availableEquity, trustRemainingCapacity);

          const setAmountByLVR = (targetLVR) => {
              const targetLoan = property.value * (targetLVR / 100);
              const additionalNeeded = targetLoan - property.loan;
              if (additionalNeeded > 0) {
                  const cappedAmount = Math.min(additionalNeeded, maxReleaseable);
                  setAmountToRelease(Math.floor(cappedAmount));
              } else {
                  setAmountToRelease(0);
              }
          };

          const newTotalLoanRaw = property.loan + amountToRelease;
          const lmiCost = calculateLMI(newTotalLoanRaw, property.value);
          const finalNewLoan = newTotalLoanRaw + lmiCost;
          const finalLVR = (finalNewLoan / property.value) * 100;

          return (
              <Modal title="Release Equity" onClose={onClose}>
                  <form onSubmit={(e) => {
                      e.preventDefault();
                      if (amountToRelease > 0 && amountToRelease <= maxReleaseable) {
                          onRefinance(trust.id, property.id, amountToRelease, lmiCost);
                      }
                  }} className="space-y-6">
                      
                      <div>
                          <label className="block text-sm font-medium text-slate-700 mb-1">Select Property</label>
                          <select value={selectedId} onChange={(e) => {
                              setSelectedId(e.target.value);
                              setAmountToRelease(0);
                          }} className="w-full border p-2 rounded-lg">
                              {properties.map(({ prop, trustId: tId }) => {
                                 const t = trusts.find(tr => tr.id === tId);
                                 return <option key={prop.id} value={prop.id}>{prop.name} ({t?.name})</option>
                              })}
                          </select>
                      </div>

                      <div className="bg-slate-50 p-4 rounded-lg space-y-2 text-sm">
                          <div className="flex justify-between"><span>Current Value:</span> <span>{formatCurrency(property.value)}</span></div>
                          <div className="flex justify-between"><span>Current Loan ({(property.loan/property.value*100).toFixed(1)}%):</span> <span>{formatCurrency(property.loan)}</span></div>
                          <div className="border-t pt-2 flex justify-between font-bold text-green-600">
                              <span>Max Releaseable (88% LVR):</span> 
                              <span>{formatCurrency(maxReleaseable)}</span>
                          </div>
                      </div>

                      <div>
                          <div className="flex justify-between items-end mb-1">
                              <label className="block text-sm font-medium text-slate-700">Amount to Release</label>
                              <div className="flex gap-2">
                                   <button 
                                      type="button"
                                      onClick={() => setAmountByLVR(80)}
                                      className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200 transition"
                                   >
                                      Max 80%
                                   </button>
                                   <button 
                                      type="button"
                                      onClick={() => setAmountByLVR(88)}
                                      className="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded hover:bg-purple-200 transition"
                                   >
                                      Max 88%
                                   </button>
                              </div>
                          </div>
                          <div className="relative">
                              <span className="absolute left-3 top-2.5 text-slate-500">$</span>
                              <input 
                                  type="text" 
                                  value={formatNumber(amountToRelease)}
                                  onChange={(e) => {
                                      const val = parseFormattedNumber(e.target.value);
                                      if (!isNaN(val) && val <= maxReleaseable) setAmountToRelease(val);
                                  }}
                                  className="w-full pl-8 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                              />
                          </div>
                          <input 
                              type="range" 
                              min="0" 
                              max={maxReleaseable} 
                              value={amountToRelease} 
                              onChange={(e) => setAmountToRelease(Number(e.target.value))}
                              className="w-full mt-2 accent-blue-600"
                          />
                          
                          <div className="flex justify-between text-xs text-slate-500 mt-1">
                              <span>$0</span>
                              <span>{formatCurrency(maxReleaseable)}</span>
                          </div>

                          {amountToRelease > 0 && (
                               <div className="mt-4 p-3 bg-slate-50 rounded-lg text-sm border border-slate-200 space-y-1">
                                  {lmiCost > 0 && (
                                      <div className="flex justify-between text-orange-600 items-center">
                                          <span className="flex items-center gap-1"><AlertTriangle className="w-3 h-3"/> LMI Added (1.5%):</span>
                                          <span>{formatCurrency(lmiCost)}</span>
                                      </div>
                                  )}
                                  <div className="flex justify-between">
                                      <span>New Loan Amount:</span>
                                      <span>{formatCurrency(finalNewLoan)}</span>
                                  </div>
                                  <div className="flex justify-between font-bold">
                                      <span>New LVR:</span>
                                      <span className={finalLVR > 80 ? 'text-orange-600' : 'text-slate-800'}>{finalLVR.toFixed(2)}%</span>
                                  </div>
                               </div>
                          )}
                      </div>

                      <button 
                          disabled={amountToRelease <= 0 || amountToRelease > maxReleaseable} 
                          type="submit" 
                          className="w-full bg-emerald-600 disabled:bg-slate-300 disabled:cursor-not-allowed hover:bg-emerald-700 text-white font-bold py-3 rounded-lg transition shadow hover:shadow-lg"
                      >
                          Confirm & Cash Out {formatCurrency(amountToRelease)}
                      </button>
                  </form>
              </Modal>
          );
      };

      // 4. MAIN APP
      const App = () => {
        const [gameState, setGameState] = useState(INITIAL_GAME_STATE);
        const [showBuyModal, setShowBuyModal] = useState(false);
        const [preSelectedTrustId, setPreSelectedTrustId] = useState(undefined);
        const [refinanceSelection, setRefinanceSelection] = useState(null);
        const [sellSelection, setSellSelection] = useState(null);
        const [payDownSelection, setPayDownSelection] = useState(null);
        const [showHistory, setShowHistory] = useState(false);

        const totalProperties = useMemo(() => 
          gameState.trusts.reduce((acc, t) => acc + t.properties.length, 0), 
        [gameState.trusts]);

        const totalValue = useMemo(() => 
          gameState.trusts.reduce((acc, t) => acc + t.properties.reduce((pAcc, p) => pAcc + p.value, 0), 0), 
        [gameState.trusts]);

        const totalDebt = useMemo(() => 
          gameState.trusts.reduce((acc, t) => acc + t.properties.reduce((pAcc, p) => pAcc + p.loan, 0), 0), 
        [gameState.trusts]);

        const totalEquity = totalValue - totalDebt;
        const netWorth = totalEquity + gameState.cash;

        const annualCashflow = useMemo(() => {
          let total = 0;
          gameState.trusts.forEach(trust => {
            trust.properties.forEach(prop => {
              const monthlyRent = (prop.value * (prop.yieldRate / 100)) / 12;
              const monthlyInterest = calculateMonthlyInterest(prop.loan, prop.interestRate);
              const monthlyExpenses = prop.type === 'RESIDENTIAL' 
                ? monthlyRent * 0.20 
                : monthlyRent * 0.10;
              
              total += (monthlyRent - monthlyInterest - monthlyExpenses);
            });
          });
          return total * 12; 
        }, [gameState.trusts]);

        const handleStart = (setupData) => {
          setGameState(prev => ({ ...prev, ...setupData, setupComplete: true }));
        };

        const handleOpenTrust = () => {
          if (gameState.cash < 3000) {
            alert("Insufficient cash to open a Trust ($3,000 required).");
            return;
          }
          const newTrust = {
            id: Math.random().toString(36).substr(2, 9),
            name: `Trust ${gameState.trusts.length + 1}`,
            properties: []
          };
          setGameState(prev => ({
            ...prev,
            cash: prev.cash - 3000,
            trusts: [...prev.trusts, newTrust]
          }));
        };

        const handleBuyProperty = (trustId, propertyData, cost) => {
          const newProperty = {
            ...propertyData,
            id: Math.random().toString(36).substr(2, 9),
            boughtAt: gameState.year * 12 + gameState.month
          };

          setGameState(prev => {
            const updatedTrusts = prev.trusts.map(t => {
              if (t.id === trustId) {
                return { ...t, properties: [...t.properties, newProperty] };
              }
              return t;
            });
            return {
              ...prev,
              cash: prev.cash - cost,
              trusts: updatedTrusts
            };
          });
          setShowBuyModal(false);
          setPreSelectedTrustId(undefined);
        };

        const handleSellProperty = (trustId, propertyId, netProceeds) => {
          setGameState(prev => {
              const updatedTrusts = prev.trusts.map(t => {
                  if(t.id === trustId) {
                      return {
                          ...t,
                          properties: t.properties.filter(p => p.id !== propertyId)
                      }
                  }
                  return t;
              });

              return {
                  ...prev,
                  cash: prev.cash + netProceeds,
                  trusts: updatedTrusts
              }
          });
          setSellSelection(null);
        }

        const handlePayDownLoan = (trustId, propertyId, amount) => {
            setGameState(prev => {
                const updatedTrusts = prev.trusts.map(t => {
                    if (t.id === trustId) {
                        return {
                            ...t,
                            properties: t.properties.map(p => {
                                if (p.id === propertyId) {
                                    return { ...p, loan: Math.max(0, p.loan - amount) };
                                }
                                return p;
                            })
                        }
                    }
                    return t;
                });
                return {
                    ...prev,
                    cash: prev.cash - amount,
                    trusts: updatedTrusts
                }
            });
            setPayDownSelection(null);
        }

        const handleRefinance = (trustId, propertyId, additionalLoan, lmiCost) => {
          setGameState(prev => {
            const updatedTrusts = prev.trusts.map(t => {
              if (t.id === trustId) {
                const updatedProps = t.properties.map(p => {
                  if (p.id === propertyId) {
                    return { ...p, loan: p.loan + additionalLoan + lmiCost };
                  }
                  return p;
                });
                return { ...t, properties: updatedProps };
              }
              return t;
            });
            return {
              ...prev,
              cash: prev.cash + additionalLoan,
              trusts: updatedTrusts
            };
          });
          setRefinanceSelection(null);
        };

        const advanceTime = () => {
          const monthsPassed = 3;
          let accumulatedCash = 0;
          
          const newTrusts = gameState.trusts.map(trust => {
            const newProperties = trust.properties.map(prop => {
              const annualRent = prop.value * (prop.yieldRate / 100);
              const periodRent = (annualRent / 12) * monthsPassed;
              
              const annualInterest = prop.loan * (prop.interestRate / 100);
              const periodInterest = (annualInterest / 12) * monthsPassed;

              const expenseRate = prop.type === 'RESIDENTIAL' ? 0.20 : 0.10;
              const periodExpenses = periodRent * expenseRate;

              accumulatedCash += (periodRent - periodInterest - periodExpenses);

              const growthFactor = 1 + (prop.growthRate / 100) * (monthsPassed / 12);
              const newValue = prop.value * growthFactor;

              return { ...prop, value: newValue };
            });
            return { ...trust, properties: newProperties };
          });

          const quarterlySavings = (gameState.salary * (gameState.savingsRate / 100)) / 4;
          accumulatedCash += quarterlySavings;

          let newMonth = gameState.month + monthsPassed;
          let newYear = gameState.year;
          if (newMonth >= 12) {
            newYear += 1;
            newMonth = newMonth % 12;
          }

          const nextTotalValue = newTrusts.reduce((acc, t) => acc + t.properties.reduce((pAcc, p) => pAcc + p.value, 0), 0);
          const nextTotalDebt = newTrusts.reduce((acc, t) => acc + t.properties.reduce((pAcc, p) => pAcc + p.loan, 0), 0); 
          const nextCash = gameState.cash + accumulatedCash;
          const nextNetWorth = nextTotalValue - nextTotalDebt + nextCash;

          setGameState(prev => ({
            ...prev,
            year: newYear,
            month: newMonth,
            cash: nextCash,
            trusts: newTrusts,
            history: [...prev.history, { 
              label: `Y${newYear}`, 
              netWorth: nextNetWorth,
              cash: nextCash,
              debt: nextTotalDebt 
            }]
          }));
        };

        if (!gameState.setupComplete) {
          return <SetupScreen onStart={handleStart} />;
        }

        const allProperties = gameState.trusts.flatMap(t => t.properties.map(p => ({ prop: p, trustId: t.id })));
        const timelineMaxYear = Math.max(10, gameState.year + 2); 
        const currentProgress = gameState.year + (gameState.month / 12);
        const progressPercentage = Math.min((currentProgress / timelineMaxYear) * 100, 100);
        const timelineTicks = Array.from({ length: timelineMaxYear + 1 }, (_, i) => i);

        return (
          <div className="min-h-screen bg-slate-50 text-slate-900 font-sans pb-20">
            {/* Top Bar */}
            <div className="sticky top-0 z-30 bg-white border-b border-slate-200 shadow-sm px-4 py-3 lg:px-8">
              <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                <div className="flex items-center gap-4">
                  <AppLogo size="small" />
                  <div className="flex flex-col md:flex-row md:items-center gap-4">
                    <h1 className="text-xl md:text-2xl font-bold tracking-tight text-slate-800">PropertySim</h1>
                  </div>
                </div>
                
                <div className="flex gap-4 lg:gap-8 w-full md:w-auto overflow-x-auto pb-2 md:pb-0 items-center">
                   <div className="flex flex-col min-w-[100px] border-r border-slate-100 pr-6 mr-2">
                      <span className="text-[10px] text-slate-500 uppercase font-bold flex items-center gap-1"><Clock className="w-3 h-3" /> Timeline</span>
                      <span className="text-xl font-bold text-slate-800 flex items-baseline gap-1">
                         Y{gameState.year} <span className="text-sm text-slate-400 font-medium">M{gameState.month}</span>
                      </span>
                   </div>

                   <div className="flex flex-col min-w-[100px]">
                      <span className="text-[10px] text-slate-500 uppercase font-bold">Net Worth</span>
                      <span className="text-xl font-bold text-slate-800">{formatCurrency(netWorth)}</span>
                   </div>
                   <div className="flex flex-col min-w-[100px]">
                      <span className="text-[10px] text-slate-500 uppercase font-bold">Cash</span>
                      <span className="text-xl font-bold text-emerald-600">{formatCurrency(gameState.cash)}</span>
                   </div>
                   <div className="flex flex-col min-w-[100px]">
                      <span className="text-[10px] text-slate-500 uppercase font-bold">Annual Cashflow</span>
                      <span className={`text-xl font-bold ${annualCashflow >= 0 ? 'text-blue-600' : 'text-red-600'}`}>
                        {annualCashflow > 0 ? '+' : ''}{formatCurrency(annualCashflow)}
                      </span>
                   </div>
                   
                   <div className="h-8 w-px bg-slate-200 hidden md:block"></div>

                   <div className="flex items-center gap-2">
                      <button 
                          onClick={() => setShowHistory(!showHistory)} 
                          className={`p-2.5 rounded-lg transition border flex items-center gap-2 text-sm font-medium ${showHistory ? 'bg-blue-50 border-blue-200 text-blue-700' : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50'}`}
                      >
                          <BarChart2 className="w-5 h-5" />
                          <span className="hidden md:inline">Chart</span>
                      </button>
                      <button 
                      onClick={advanceTime} 
                      className="flex items-center gap-2 bg-slate-800 hover:bg-slate-900 text-white px-5 py-2.5 rounded-lg text-sm font-semibold transition shadow-md hover:shadow-lg transform hover:-translate-y-0.5"
                      >
                          <Clock className="w-4 h-4" /> Fast forward
                      </button>
                  </div>
                </div>
              </div>
            </div>

            {/* Dashboard */}
            <div className="max-w-7xl mx-auto p-4 lg:p-8 space-y-8">
              {/* Timeline Vis */}
              <div className="w-full bg-white rounded-xl p-6 border border-slate-200 shadow-sm">
                 <div className="flex justify-between items-center mb-4">
                     <span className="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-1"><Clock className="w-3 h-3" /> Investment Journey</span>
                     <span className="text-xs font-semibold text-blue-600 bg-blue-50 px-2 py-1 rounded border border-blue-100">Projected Scale</span>
                 </div>
                 
                 <div className="px-4"> 
                   <div className="relative h-3 bg-slate-100 rounded-full w-full mt-2">
                      {timelineTicks.map(year => (
                          <div key={year} className="absolute top-0 bottom-0 w-px bg-slate-300 h-full" style={{ left: `${(year / timelineMaxYear) * 100}%` }}></div>
                      ))}
                      
                      <div 
                        className="absolute top-0 left-0 bottom-0 bg-blue-500 rounded-full transition-all duration-300 ease-out"
                        style={{ width: `${progressPercentage}%` }}
                      >
                          <div className="absolute right-0 top-1/2 -translate-y-1/2 w-4 h-4 bg-white border-4 border-blue-600 rounded-full shadow-lg z-10" />
                      </div>
                   </div>
                   
                   <div className="relative h-6 mt-2">
                       {timelineTicks.map(year => (
                          <span 
                            key={year} 
                            className="text-[10px] text-slate-400 font-medium absolute top-0 -translate-x-1/2"
                            style={{ left: `${(year / timelineMaxYear) * 100}%` }}
                          >
                             Y{year}
                          </span>
                       ))}
                   </div>
                 </div>
              </div>
              
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <StatCard label="Total Equity" value={formatCurrency(totalEquity)} icon={<Wallet className="w-4 h-4"/>} color="green" />
                  <StatCard label="Portfolio Value" value={formatCurrency(totalValue)} icon={<TrendingUp className="w-4 h-4"/>} color="blue" />
                  <StatCard label="Total Debt" value={formatCurrency(totalDebt)} icon={<Briefcase className="w-4 h-4"/>} color="slate" />
                  <StatCard label="Trusts Active" value={gameState.trusts.length.toString()} subValue={`Cap: ${formatCurrency(gameState.maxBorrowingPerTrust)} ea`} icon={<Building className="w-4 h-4"/>} />
              </div>

              {showHistory && (
                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 animate-in slide-in-from-top-4 duration-300">
                   <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2"><PieChart className="w-4 h-4"/> Performance History</h3>
                   <div className="h-72 w-full">
                      <ResponsiveContainer width="100%" height="100%">
                        <LineChart data={gameState.history} margin={{ top: 5, right: 30, left: 20, bottom: 5 }}>
                          <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" vertical={false} />
                          <XAxis dataKey="label" stroke="#94a3b8" fontSize={12} tickLine={false} axisLine={false} dy={10} />
                          <YAxis stroke="#94a3b8" fontSize={12} tickFormatter={(val) => `$${val/1000}k`} tickLine={false} axisLine={false} dx={-10} />
                          <Tooltip 
                              contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }}
                              formatter={(value, name) => [formatCurrency(value), name]} 
                          />
                          <Legend verticalAlign="top" height={36} />
                          <Line name="Net Worth" type="monotone" dataKey="netWorth" stroke="#2563eb" strokeWidth={3} dot={{ r: 4, fill: '#2563eb', strokeWidth: 0 }} activeDot={{ r: 6 }} />
                          <Line name="Cash" type="monotone" dataKey="cash" stroke="#10b981" strokeWidth={3} dot={{ r: 4, fill: '#10b981', strokeWidth: 0 }} />
                          <Line name="Debt" type="monotone" dataKey="debt" stroke="#cbd5e1" strokeWidth={2} strokeDasharray="5 5" dot={false} />
                        </LineChart>
                      </ResponsiveContainer>
                   </div>
                </div>
              )}

              <div className="flex flex-wrap gap-4">
                 <button 
                   onClick={() => {
                      if(gameState.trusts.length === 0) { alert("Open a Trust first!"); return; }
                      setShowBuyModal(true);
                   }} 
                   className="flex-1 md:flex-none flex items-center justify-center gap-2 bg-white border border-slate-300 hover:border-blue-400 hover:text-blue-600 text-slate-700 px-6 py-4 rounded-xl shadow-sm transition group"
                 >
                    <div className="bg-slate-100 group-hover:bg-blue-100 p-2 rounded-full transition"><Home className="w-5 h-5" /></div>
                    <div className="text-left">
                      <div className="font-bold text-sm">Buy Property</div>
                      <div className="text-xs text-slate-400">Res or Comm</div>
                    </div>
                 </button>

                 <button 
                   onClick={() => {
                      if(totalProperties === 0) { alert("No properties to refinance."); return; }
                      setRefinanceSelection({ trustId: gameState.trusts[0].id, propertyId: gameState.trusts[0].properties[0].id });
                   }}
                   className="flex-1 md:flex-none flex items-center justify-center gap-2 bg-white border border-slate-300 hover:border-blue-400 hover:text-blue-600 text-slate-700 px-6 py-4 rounded-xl shadow-sm transition group"
                 >
                    <div className="bg-slate-100 group-hover:bg-blue-100 p-2 rounded-full transition"><DollarSign className="w-5 h-5" /></div>
                    <div className="text-left">
                      <div className="font-bold text-sm">Equity Release</div>
                      <div className="text-xs text-slate-400">Up to 88% LVR</div>
                    </div>
                 </button>
              </div>

              <div>
                 <h2 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                    Portfolio Structure 
                    <span className="text-xs font-normal text-slate-500 bg-slate-100 px-2 py-1 rounded-full">{gameState.trusts.length} Entities</span>
                 </h2>
                 
                   <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                     {gameState.trusts.map(trust => {
                       const trustValue = trust.properties.reduce((acc, p) => acc + p.value, 0);
                       const trustDebt = trust.properties.reduce((acc, p) => acc + p.loan, 0);
                       const capacityUsed = (trustDebt / gameState.maxBorrowingPerTrust) * 100;

                       return (
                         <div key={trust.id} className="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col h-full">
                            <div className="bg-slate-50 px-5 py-3 border-b border-slate-100 rounded-t-xl">
                               <div className="flex justify-between items-center mb-1">
                                  <h3 className="font-bold text-slate-800 flex items-center gap-2">
                                     <Briefcase className="w-4 h-4 text-slate-500" /> {trust.name}
                                  </h3>
                                  <div className="text-xs font-semibold bg-white border px-2 py-0.5 rounded text-slate-500">
                                     {trust.properties.length} Assets
                                  </div>
                               </div>
                               <div className="flex justify-between text-xs text-slate-500">
                                   <span>Borrowed: {formatCurrency(trustDebt)}</span>
                                   <span className={capacityUsed > 90 ? 'text-red-500 font-bold' : ''}>
                                      {capacityUsed.toFixed(0)}% Cap
                                   </span>
                               </div>
                               <div className="h-1.5 w-full bg-slate-200 rounded-full mt-2 overflow-hidden">
                                  <div 
                                    className={`h-full rounded-full ${capacityUsed > 90 ? 'bg-red-500' : 'bg-blue-500'}`} 
                                    style={{ width: `${Math.min(capacityUsed, 100)}%` }} 
                                  />
                               </div>
                            </div>
                            
                            <div className="p-4 space-y-4 flex-grow bg-slate-50/30">
                               {trust.properties.length === 0 && (
                                  <div className="flex flex-col items-center justify-center text-center py-6 border-2 border-dashed border-slate-200 rounded-lg bg-slate-50/50">
                                      <p className="text-sm text-slate-400 italic mb-3">No assets in this trust.</p>
                                      <button 
                                        onClick={() => {
                                            setPreSelectedTrustId(trust.id);
                                            setShowBuyModal(true);
                                        }}
                                        className="text-xs bg-white border border-blue-200 text-blue-600 px-3 py-1.5 rounded-md hover:bg-blue-50 transition shadow-sm font-medium flex items-center gap-1"
                                      >
                                          <Plus className="w-3 h-3" /> Buy Property
                                      </button>
                                  </div>
                               )}
                               {trust.properties.map(prop => {
                                  const equity = prop.value - prop.loan;
                                  const usableEquity = Math.max(0, getMaxLoan(prop.value) - prop.loan);
                                  const lvr = (prop.loan / prop.value) * 100;
                                  const profitSinceBuy = prop.value - prop.originalPrice;
                                  const profitPercent = (profitSinceBuy / prop.originalPrice) * 100;
                                  
                                  const boughtYear = Math.floor(prop.boughtAt / 12);
                                  const boughtMonth = prop.boughtAt % 12;

                                  return (
                                     <div key={prop.id} className="relative bg-white border border-slate-200 rounded-lg shadow-sm hover:shadow-md transition group">
                                        <div className="p-3 border-b border-slate-100 flex justify-between items-start">
                                           <div className="flex items-center gap-2">
                                              <div className={`p-1.5 rounded-md ${prop.type === 'RESIDENTIAL' ? 'bg-blue-100 text-blue-600' : 'bg-purple-100 text-purple-600'}`}>
                                                  {prop.type === 'RESIDENTIAL' ? <Home className="w-4 h-4" /> : <Store className="w-4 h-4" />}
                                              </div>
                                              <div>
                                                  <div className="font-semibold text-slate-800 text-sm leading-tight">{prop.name}</div>
                                                  <div className="text-[10px] text-slate-400 uppercase tracking-wide">
                                                      {prop.type === 'RESIDENTIAL' ? 'Bread & Butter' : 'Commercial'}
                                                  </div>
                                              </div>
                                           </div>
                                           <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded ${lvr > 80 ? 'bg-orange-50 text-orange-600 border border-orange-100' : 'bg-emerald-50 text-emerald-600 border border-emerald-100'}`}>
                                              {lvr.toFixed(0)}% LVR
                                           </span>
                                        </div>
                                        
                                        <div className="p-3 grid grid-cols-2 gap-y-2 gap-x-4 text-sm relative">
                                            <div className="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-[110%] w-72 bg-slate-800 text-white text-xs rounded-lg p-3 shadow-xl opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50">
                                                <h5 className="font-bold border-b border-slate-600 pb-1 mb-2 text-slate-300">Asset Details</h5>
                                                <div className="grid grid-cols-2 gap-y-1 gap-x-4">
                                                    <span className="text-slate-400">Bought:</span> <span className="text-right">Year {boughtYear}, Month {boughtMonth}</span>
                                                    <span className="text-slate-400">Original Price:</span> <span className="text-right">{formatCurrency(prop.originalPrice)}</span>
                                                    <span className="text-slate-400">Current Value:</span> <span className="text-right font-bold text-white">{formatCurrency(prop.value)}</span>
                                                    <span className="text-slate-400">Current Debt:</span> <span className="text-right text-red-200">{formatCurrency(prop.loan)}</span>
                                                    <span className="text-slate-400">Net Equity:</span> <span className="text-right text-emerald-300">{formatCurrency(equity)}</span>
                                                    <div className="col-span-2 h-px bg-slate-600 my-1"></div>
                                                    <span className="text-slate-400">Growth:</span> <span className="text-right text-green-400">+{profitPercent.toFixed(1)}%</span>
                                                    <span className="text-slate-400">Yield:</span> <span className="text-right">{prop.yieldRate}%</span>
                                                </div>
                                                <div className="absolute bottom-0 left-1/2 -translate-x-1/2 translate-y-1/2 rotate-45 w-2 h-2 bg-slate-800"></div>
                                            </div>

                                            <div className="flex flex-col">
                                                <span className="text-[10px] text-slate-400 uppercase">Value</span>
                                                <span className="font-semibold text-slate-700">{formatCurrency(prop.value)}</span>
                                            </div>
                                            <div className="flex flex-col text-right">
                                                <span className="text-[10px] text-slate-400 uppercase">Loan</span>
                                                <span className="font-medium text-slate-600">{formatCurrency(prop.loan)}</span>
                                            </div>
                                            <div className="flex flex-col">
                                                <span className="text-[10px] text-slate-400 uppercase">Equity</span>
                                                <span className="font-medium text-emerald-600">{formatCurrency(equity)}</span>
                                            </div>
                                            <div className="flex flex-col text-right">
                                                <span className="text-[10px] text-slate-400 uppercase">Usable</span>
                                                <span className="font-medium text-blue-600">{formatCurrency(usableEquity)}</span>
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-2 border-t border-slate-100 divide-x divide-slate-100">
                                            <button 
                                              onClick={() => setRefinanceSelection({ trustId: trust.id, propertyId: prop.id })}
                                              className="py-2 text-xs font-medium text-slate-600 hover:bg-slate-50 hover:text-blue-600 transition flex items-center justify-center gap-1"
                                            >
                                                <Coins className="w-3 h-3" /> Equity
                                            </button>
                                            {prop.type === 'COMMERCIAL' ? (
                                                <div className="grid grid-cols-2 divide-x divide-slate-100">
                                                    <button 
                                                      onClick={() => setPayDownSelection({ trustId: trust.id, property: prop })}
                                                      className="py-2 text-xs font-medium text-slate-600 hover:bg-slate-50 hover:text-blue-600 transition flex items-center justify-center gap-1"
                                                      title="Pay Down Loan"
                                                    >
                                                        <ArrowDownCircle className="w-3 h-3" /> Pay loan
                                                    </button>
                                                    <button 
                                                      onClick={() => setSellSelection({ trustId: trust.id, property: prop })}
                                                      className="py-2 text-xs font-medium text-slate-600 hover:bg-red-50 hover:text-red-600 transition flex items-center justify-center gap-1"
                                                      title="Sell Asset"
                                                    >
                                                        <DollarSign className="w-3 h-3" /> Sell
                                                    </button>
                                                </div>
                                            ) : (
                                              <button 
                                                  onClick={() => setSellSelection({ trustId: trust.id, property: prop })}
                                                  className="py-2 text-xs font-medium text-slate-600 hover:bg-red-50 hover:text-red-600 transition flex items-center justify-center gap-1"
                                              >
                                                  <DollarSign className="w-3 h-3" /> Sell
                                              </button>
                                            )}
                                        </div>
                                     </div>
                                  );
                               })}
                            </div>
                         </div>
                       );
                     })}

                      <button 
                          onClick={handleOpenTrust}
                          className="group border-2 border-dashed border-slate-300 rounded-xl flex flex-col items-center justify-center p-8 hover:border-blue-400 hover:bg-blue-50/50 transition h-full min-h-[200px]"
                      >
                          <div className="bg-slate-100 group-hover:bg-blue-200 p-4 rounded-full mb-3 transition">
                              <Plus className="w-6 h-6 text-slate-500 group-hover:text-blue-700" />
                          </div>
                          <span className="font-semibold text-slate-600 group-hover:text-blue-700">Open New Trust</span>
                          <span className="text-sm text-slate-400 mt-1">Cost: $3,000</span>
                      </button>

                   </div>
                 
              </div>

            </div>

            {showBuyModal && (
              <BuyPropertyModal 
                trusts={gameState.trusts} 
                cash={gameState.cash} 
                maxBorrowingPerTrust={gameState.maxBorrowingPerTrust}
                initialTrustId={preSelectedTrustId}
                onClose={() => {
                    setShowBuyModal(false);
                    setPreSelectedTrustId(undefined);
                }}
                onBuy={handleBuyProperty}
              />
            )}

            {refinanceSelection && (
              <RefinanceModal 
                properties={allProperties}
                maxBorrowingPerTrust={gameState.maxBorrowingPerTrust}
                trusts={gameState.trusts}
                initialSelection={refinanceSelection}
                onClose={() => setRefinanceSelection(null)}
                onRefinance={handleRefinance}
              />
            )}

            {sellSelection && (
                <SellPropertyModal 
                  property={sellSelection.property}
                  trustId={sellSelection.trustId}
                  currentDate={{ year: gameState.year, month: gameState.month }}
                  onClose={() => setSellSelection(null)}
                  onSell={handleSellProperty}
                />
            )}

            {payDownSelection && (
                <PayDownModal 
                  property={payDownSelection.property}
                  trustId={payDownSelection.trustId}
                  cashAvailable={gameState.cash}
                  onClose={() => setPayDownSelection(null)}
                  onPayDown={handlePayDownLoan}
                />
            )}
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>